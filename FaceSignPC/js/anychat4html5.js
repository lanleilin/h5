/*! Copyright (c) 2005--2017 BaiRuiTech.Co.Ltd. All rights reserved. */
!function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){function o(e){var t=new Date,n=t.getDate()>9?t.getDate():"0"+t.getDate(),o=t.getMonth()+1>9?t.getMonth()+1:"0"+(t.getMonth()+1),s=t.getFullYear(),d=t.getHours()>9?t.getHours():"0"+t.getHours(),c=t.getMinutes()>9?t.getMinutes():"0"+t.getMinutes(),u=t.getSeconds()>9?t.getSeconds():"0"+t.getSeconds();if(console.log(e),i.Uploadlog("["+s+"-"+o+"-"+n+" "+d+":"+c+":"+u+"] "+e),a=a+"\r\n & time："+d+":"+c+":"+u+":  "+e,e='<p><span class="text-info">time：'+d+":"+c+":"+u+"</span>&nbsp;&nbsp;&nbsp;&nbsp;"+e+"</p>",document.getElementById("log")){var f=document.getElementById("log").innerHTML;document.getElementById("log").innerHTML=e+f}r.putLog(a)}var i=n(1),r=n(11),a="";window.AnyChatSDK=i.instance,window.log=o,window.log_obj=r},function(e,t,n){function o(e){var t={};t.msgbuf=e,h&&h.socket_send("request",0,"uploadlog",t)}var i=n(2),r=n(5),a=n(6),s=n(8),d=n(3),c=n(9),u=n(10),f=window.URL||window.webkitURL||window.msURL||window.oURL,l={},h=null,p=function(){function e(e){}function t(e,t){var n=e+":"+t,o=[];return o.push(n),we.addr=o,h.sessionid=null,h.connect(o),we.connectaddr=n,log("Invoke\tConnect("+e+","+t+")=0"),0}function n(e,t,n){if(ve.getStringLength(e)>200||0==ve.getStringLength(e))return 21;var o={};return o.username=e,o.password=t,o.passenctype=n,o.platformtype=he,o.username&&h.socket_send("request",0,"login",o),ge.connect||(we.loginData={},we.loginData=o),ce[-1].username=e,0}function o(e,t,n,o,i,r,a){if(ve.getStringLength(e)>200||0==ve.getStringLength(e))return 21;var s={};return s.nickname=e,s.userid=t,s.struserid=n,s.appid=o,s.timestamp=i,s.lpSigStr=r,s.lpStrParam=a,s.platformtype=he,h.socket_send("request",0,"loginex",s),ce[-1].username=e,0}function p(e,t,n){var o={};return o.roomid=e,o.roompass=t,o.passenctype=n,h.userid===-1?(log("还没有登录成功，不能进房间"),!1):void h.socket_send("request",0,"enterroom",o)}function m(e,t){var n={};n.roomname=e,n.roompass=t,n.passenctype=dwParam,h.socket_send("request",0,"enterroomex",n)}function v(e){var t={};return h.roomid?(ve.closeAll(le),e||(e=-1),t.roomid=e,h.roomid=0,h.userlist=[],h.socket_send("request",0,"leaveroom",t),0):(log("但不成功，因为没有进入房间"),20)}function g(e,t){var n={};n.userid=e,n.jsonbuf=ve.base64encode(t),h.socket_send("request",0,"transbuffer",n)}function b(e,t,n,o,i){var r={};r.userid=e,r.jsonbuf=ve.base64encode(t),r.param1=n,r.param2=o,r.flags=i,h.socket_send("request",0,"transbufferex",r)}function w(){var e={};return h.socket_send("request",0,"logout",e),0}function y(e,t,n,o,i,r){var a={};a.eventtype=e,a.userid=t,a.errorcode=n,a.flags=o,a.param=i,log("videoCallControl："+r+"-"+a.userstr),h.socket_send("request",0,"videocallcontrol",a)}function S(e,t,n,o){var i={};i.objecttype=e,i.objectid=t,i.infoname=n,i.infovalue=o,i.valuetype=1,h.socket_send("request",0,"objectsetvalue",i)}function C(e,t,n,o){var i={};i.objecttype=e,i.objectid=t,i.infoname=n,i.infovalue=o,i.valuetype=0,h.socket_send("request",0,"objectsetvalue",i)}function k(e,t,n){var o={};return o.objecttype=e,o.objectid=t,o.infoname=n,h.socket_send("request",0,"objectgetvalue",o),se.GetObjectIntValue(e,t,n)}function O(e,t,n){var o={};return o.objecttype=e,o.objectid=t,o.infoname=n,h.socket_send("request",0,"objectgetvalue",o),se.GetObjectStringValue(e,t,n)}function A(e,t,n,o,i,r,a,s){var d={};if(d.objecttype=e,d.objectid=t,501==n?h.queueId=t:502==n&&(d.objectid=h.queueId),d.ctrlcode=n,d.param1=o,d.param2=i,d.param3=r,d.param4=a,d.strparam=s,h.socket_send("request",0,"objectcontrol",d),502==n)return 0}function _(e){var t={};return t.objecttype=e,h.socket_send("request",0,"objectgetidlist",t),se.ObjectGetIdList(e)}function I(e,t){var n={};return n.optname=e,n.optval=t,135==e?(log(t),0):void(ge.connect?h.socket_send("request",0,"setsdkoptionstring",n):we.SetSDKOptionStringArr.push(n))}function M(e,t){var n={};n.optname=e,n.optval=t,ge.connect?h.socket_send("request",0,"setsdkoptionint",n):we.SetSDKOptionIntArr.push(n)}function x(e){var t={};t.optname=e,h.socket_send("request",0,"getsdkoptionstring",t)}function D(e){var t={};t.optname=e,h.socket_send("request",0,"getsdkoptionint",t)}function T(e,t){var n={};n.userid=e,n.open=t,R(e,t,0,0,"")}function R(e,t,n,o,i){if(!h.roomid)return log("还没有进入房间"),309;h.userlist;if(!e)return log("请输入对方userid"),309;log("UserCameraControlEx("+e+","+t+", "+n+", "+o+", "+i+")");var r={};r.userid=e,r.open=t,r.streamindex=n,r.flags=o,r.strparam=i;var a,s=we.streamindex_video,d="";if(h.socket_send("request",0,"usercameracontrolex",r),e==-1||e==h.userid)if(log("outputStreamInfo:"+JSON.stringify(s)),s[n]?(d=s[n].cameraName,a=s[n]):BRAC_SetUserStreamInfo(-1,0,BRAC_SO_LOCALVIDEO_DEVICENAME,""),0==t)ve.closeMyCamera(le),ce[-1].camerastate=1,ce[h.userid].camerastate=1;else{var c=Y(d);ve.createStream(c,a)}else if(0==t){var u=we.setvideoposData,f=0;for(var l in u)u[l].userId==e&&u[l].streamIndex==n&&(f=u[l].peerId);0!=f&&ve.closeOtherCamera(f)}else{var p=h.sessionid+"_"+e+"_"+n;log("打开对方摄像头："+p);var m={};m.peerId=p,m.userId=e,m.streamIndex=n,we.setvideoposData.push(m),h.createPeerConnection(p,n),h.addStreams(p)}return 0}function E(e,t){var n={};return e?(n.userid=e,n.open=t,void h.socket_send("request",0,"userspeakcontrol",n)):219}function j(e,t,n,o,i){var r={};return e?(r.userid=e,r.open=t,void h.socket_send("request",0,"userspeakcontrol",r)):219}function L(e,t,n,o){var i={};return e?(i.userid=e,i.secret=t,i.buf=ve.base64encode(n),i.buf.length>8e3?712:(h.socket_send("request",0,"sendtextmessage",i),0)):219}function U(e){}function B(e){return 1==e?(we.device_video_once=0,ue.length):2==e?(we.device_audio_once=0,fe.length):void 0}function N(e){if(1==e){var t=ue[we.device_video_once++];return t.label}if(2==e){var t=fe[we.device_audio_once++];return t.label}}function V(e,t,n,o){n==BRAC_SO_LOCALVIDEO_BITRATECTRL&&me&&h.updatebrandwidth(me,o),we.streamindex_video=ve.strema_video(we,t,n,o)}function q(e,t,n,o){we.streamindex_video=ve.strema_video(we,t,n,o)}function G(e){var t;return e==-1?t=h.userlist.filter(function(){return!0}):[]}function F(e){return e}function W(e,t){return 1==t?e==-1||e==h.userid?h.localMediaStream?2:1:ce[e].camerastate:0}function P(){return de}function z(e,t){if(1==t){if(!ce[e])return;return ce[e].username}if(2==t){if(!ce[e])return;return ce[e].userip}}function H(e){return ce[e]?ce[e].status:void 0}function K(e,t){if(1==e)for(var n in ce)if(ce[n].username===t)return n}function J(e,t){if(6==t)return ce[e]?ce[e].username:void 0}function Q(e,t,n,o){if(e==-1||e==h.userId)return 1==t?le[0]?(ye=new ae(le[0]),ye.ondataavailable=function(t){consonsole.log("生成blob"),u.upload("blob",t,"lnjnkj.webm");var n=f.createObjectURL(t);be.OnRecordSnapShotEx2(e,0,n,0,0,0,"")},ye.start(3e5),0):200:0==t?(ye.stop(),0):0}function Y(e){for(var t in ue)if(ue[t].label==e)return ue[t]}function $(e,t,n){function o(e){var t=we.setvideoposData;for(var n in t)t[n].userId==e;return n?n:-1}if(!h.roomid)return log("还没有进入房间"),!1;if(e==-1||h.userid==e){var i=document.createElement("video"),r=t;i.setAttribute("class","my"),i.setAttribute("autoplay",""),i.setAttribute("id",n),i.setAttribute("playsinline",""),r.appendChild(i),console.log("初始化显示流"),we.setMyvideoposData={userid:e,parentobj:t,id:n};var a=setInterval(function(){le[0]&&(clearInterval(a),h.attachStream(le[0],n))},500)}var s=o(e);return s!=-1&&(we.setvideoposData[s].parentobj=t,void(we.setvideoposData[s].id=n))}function X(){function e(e){for(var t=0;t!=e.length;++t){var n=e[t];"video"===n.kind||"videoinput"===n.kind?ue.push(n):"audio"!==n.kind&&"audioinput"!==n.kind||n.label.indexOf("麦克风")!=-1&&fe.push(n)}Z(ue)}ue=[],fe=[],"undefined"!=typeof MediaStreamTrack.getSources?MediaStreamTrack.getSources(e):navigator.mediaDevices.enumerateDevices().then(function(t){e(t)})}function Z(e){console.log(e);var t="",n="||";for(var o in e)n=0==o?"":"||",t+=n+e[o].label;log(t)}function ee(){}function te(){h.on("reply",function(e){var n=e.data,o=n.cmdcode,i=n.errorcode,a="",s="";if(Se[o]){switch(o){case"connect":if(ve.clear_timer(),0==i)ge.connect=!0,ve.SetSDKOptionString(we.SetSDKOptionStringArr),ve.SetSDKOptionInt(we.SetSDKOptionIntArr),we.SetSDKOptionStringArr=[],we.SetSDKOptionIntArr=[],log("Message\tOnConnect(errorcode=0,addr="+we.connectaddr+")");else if(1==i)return n.gwaddr&&n.gwport&&(ge.connect=!1,h.is_socket=!1,h.socket=null,t(n.gwaddr,n.gwport)),"errorcode 1";if(we.loginData){var e={};e=we.loginData,e.username&&h.socket_send("request",0,"login",e)}r.start(h);break;case"login":case"loginex":if(23==i||i==-1)return ee(),void log("hold 住");we.loginData={},0==i?(ce[n.userid]={},ce[-1].camerastate=1,ce[n.userid].camerastate=1,log("OnLoginSystem(userid="+n.userid+",errorcode="+i+")"),h.sessionid=n.sessionid,h.userid=a=n.userid):(log("OnLoginSystem(errorcode="+i+")"),a=-1),ce[n.userid].username=ce[-1].username;break;case"enterroom":0==i&&(h.roomid=n.roomid),a=n.roomid,log("Message OnEnterRoom(roomid:"+a+",errorcode:"+i+")")}Se[o]&&be.OnNotifyMessage(Se[o],a,s||i)}"tokenconnect"===o&&(0==i?(ve.clear_timer(),r.start(h),log("重连成功")):(h.sendData={},h.sessionid=null,log("重连失败"))),"heartbeat"===o&&r.notify(i),"logout"===o&&(log("注销成功"),h.socket.close(),ve.closeAll(le),r.stop(),d.clear_all(),h.roomid=0,h.userid=0,h.socket=null,h.normalCloseWebsocket=!0)}),h.on("request",function(e){var t=e.data,n=t.cmdcode;"restrans"===n&&d.restrans_to_service(t.begin_reg)}),h.on("notify",function(e){var t=e.data,n=t.cmdcode,o=t.errorcode,i="",r="";if(d.set_big_index_notify(e.seq),Se[n]){switch(n){case"onlineuser":var a=t.useridlist;if("object"!=typeof a&&(a=JSON.parse(a),a.userlist)){var s=a.userlist;for(var c in s)ce[s[c].userid]||(ce[s[c].userid]={}),ce[s[c].userid].username=s[c].username,ce[s[c].userid].camerastate=s[c].camerastate,log("roomuser："+s[c].username)}var u=a.useridlist;h.userlist=u,i=u.length+1,r=t.roomid;break;case"linkclose":break;case"useratroom":i=t.userid,1==t.benter?(h.userlist.push(i),ce[i]||(ce[i]={}),t.username&&log("进房间："+t.username),ce[i].username=t.username,ce[i].camerastate=t.camerastate):ve.ArrayremoveByValue(h.userlist,i),r=t.benter}Se[n]&&be.OnNotifyMessage(Se[n],i,r||o)}if("keep"===n&&(0==o&&(h.sessionid=t.sessionid,h.userid=i=t.userid),be.OnNotifyMessage(WM_GV_LOGINSYSTEM,i,r||o)),"webrtcconsult"===n&&0==o){var f=JSON.parse(t.jsonbuf);"answer"===f.type?(log("收到answer"),pe=f.sdp,me=f.peerconnectionid,"ios"===h.system?f.sdp=ve.setMediaBitrates(f.sdp,350,30):(log("answer 码率"+h.bitrate+" 系统："+h.system),f.sdp=ve.setMediaBitrates(f.sdp,h.bitrate,30)),h.receiveAnswer(f.peerconnectionid,f.sdp)):"candidate"===f.type&&(log("收到candidate"),h.candidate(f))}if("textmessage"===n){var l=ve.base64decode(t.msgbuf);be.OnAnyChatTextMessage(t.fromuserid,t.touserid,t.secret,l,0)}"objectevent"===n&&(0==t.eventtype?se.setObjectInfo(t):t.eventtype==-1?se.setObjectInfo_1(t):be.OnAnyChatObjectEvent(t.objecttype,t.objectid,t.eventtype,t.param1,t.param2,t.param3,t.param4,t.strparam)),"videocallevent"===n&&be.OnAnyChatVideoCallEvent(t.eventtype,t.userid,t.errorcode,t.flags,t.param,t.jsonbuf),"transbuffer"===n&&be.OnAnyChatTransBuffer(t.userid,ve.base64decode(t.jsonbuf),0),"transbufferex"===n&&be.OnAnyChatTransBufferex(t.userid,ve.base64decode(t.jsonbuf),0,t.param1,t.param2,t.taskid),"friendstatus"===n&&(be.OnNotifyMessage(WM_GV_FRIENDSTATUS,t.userid,t.status),ce[t.userid]=t,de.indexOf(t.userid)<0&&de.push(t.userid)),"userinfoupdate"===n&&be.OnNotifyMessage(WM_GV_USERINFOUPDATE,t.userid,t.type),"appconfiginfo"===n&&0==o&&(t.videobitrate&&(h.bitrate=t.videobitrate/1e3),t.videowidth&&(h.videowidth=t.videowidth),t.videoheight&&(h.videoheight=t.videoheight),t.videofps&&(h.videofps=t.videofps)),"camerastate"===n&&(ce[t.userid].camerastate=t.camerastate)}),h.on("stream_created",function(e){log("own stream_created"),ce[-1].camerastate=2,ce[h.userid].camerastate=2,le[0]=e}),h.on("close_websocket",function(e){log("正在尝试重连"),r.stop(),ve.tokenconnect(we.addr,le)}),h.on("linkclose",function(e){var t=WM_GV+6;be.OnNotifyMessage(t,0,e)}),h.on("offer",function(e,t){var n,o={},i={},r=we.setvideoposData;for(var a in r)r[a].peerId==t&&(n=r[a]);i.type="offer",i.sdp=e.sdp,i.peerconnectionid=t,i.streamindex=n.streamIndex,o.jsonbuf=i,h.socket_send("request",0,"webrtcconsult",o)}),h.on("pc_add_stream",function(e,t){var n=t.split("_");log("打开对方流：sessionid："+t);var o,i=we.setvideoposData;for(var r in i)i[r].peerId==t&&i[r].streamIndex==n[2]&&(o=i[r]);if(o){var a=document.createElement("video"),s=o.id,d=o.parentobj;o.parentobj&&(a.setAttribute("class","other"),a.setAttribute("name",t),a.setAttribute("autoplay",""),a.setAttribute("playsinline",""),a.setAttribute("id",s),d.appendChild(a),h.attachStream(e,s))}}),h.on("ack",function(e){d.delt_pack(e.seq)})}function ne(e,t){switch(e){case"OnNotifyMessage":be.OnNotifyMessage=t;break;case"OnVideoCallEvent":be.OnAnyChatVideoCallEvent=t;break;case"OnObjectEvent":be.OnAnyChatObjectEvent=t;break;case"OnTextMessage":be.OnAnyChatTextMessage=t;break;case"OnTransBuffer":be.OnAnyChatTransBuffer=t;break;case"OnTransBufferex":be.OnAnyChatTransBufferex=t;break;case"OnRecordSnapShotEx2":be.OnRecordSnapShotEx2=t;break;case"OnRecordSnapShot":be.OnRecordSnapShot=t}}function oe(){h.browserName=ve.getBrowser(),console.log("浏览器名字："+h.browserName),te(),setTimeout(function(){X()},1)}function ie(e,t){if(log("SelectDevice("+e+","+t+")"),1==e){var n=we.setMyvideoposData;h.localMediaStream?(BRAC_UserCameraControl(-1,0),BRAC_SetUserStreamInfo(-1,0,BRAC_SO_LOCALVIDEO_DEVICENAME,t),setTimeout(function(){BRAC_UserCameraControl(-1,1),$(n.userid,n.parentobj,n.id)},1e3)):BRAC_SetUserStreamInfo(-1,0,BRAC_SO_LOCALVIDEO_DEVICENAME,t)}}function re(e,t,n){function o(e){var t=we.setvideoposData;for(var n in t)t[n].userId==e;return n?n:-1}if(log("SnapShot("+e+", "+t+", "+n+")"),e==-1||e==h.userId){var i=we.setMyvideoposData;if(!i)return 9;var r=i.id,a=document.getElementById(r)}else{var s=o(e);if(s==-1)return 9;var r=we.setvideoposData[s].id,a=document.getElementById(r);if(!a)return 9}var d=document.createElement("canvas"),c=d.getContext("2d"),u=a.clientWidth,f=a.clientHeight;d.width=u,d.height=f,c.drawImage(a,0,0,u,f),document.getElementsByTagName("body")[0].appendChild(d),d.style.display="none";var l=d.toDataURL();return be.OnRecordSnapShot&&be.OnRecordSnapShot(e,l,n,t),l}if(l.Connect)return l;var ae=c.MediaStreamRecorder;h=new i.instance;var se=new a(h);d.setWay(h);var de=[],ce={};ce[-1]={};var ue=[],fe=[],le=[],he=0,pe="",me="",ve=s.instance(h);if(h.system=ve.system_s(),he=ve.system_s(1),log("系统："+h.system),!h.support())return log("不支持h5音视频通话，请更换浏览器"),!1;var ge={};ge.connect=!1;var be={},we={};we.setvideoposData=[],we.SetSDKOptionStringArr=[],we.SetSDKOptionIntArr=[],we.connectaddr,we.streamindex_video={},we.SetSDKOptionString=[],we.SetSDKOptionInt=[];var ye,Se={connect:WM_GV_CONNECT,login:WM_GV_LOGINSYSTEM,loginex:WM_GV_LOGINSYSTEM,enterroom:WM_GV_ENTERROOM,onlineuser:WM_GV_ONLINEUSER,linkclose:WM_GV_LINKCLOSE,useratroom:WM_GV_USERATROOM};return window.onbeforeunload=function(){w()},oe(),l.InitSDK=e,l.Connect=t,l.Login=n,l.LoginEx=o,l.EnterRoom=p,l.EnterRoomEx=m,l.LeaveRoom=v,l.Logout=w,l.on=ne,l.UserCameraControl=T,l.UserCameraControlEx=R,l.UserSpeakControl=E,l.PrepareFetchDevices=B,l.FetchNextDevice=N,l.SetVideoPos=$,l.SetUserStreamInfoString=V,l.SetUserStreamInfoInt=q,l.SetSDKOptionString=I,l.SetSDKOptionInt=M,l.VideoCallControl=y,l.SetObjectStringValue=S,l.SetObjectIntValue=C,l.GetObjectIntValue=k,l.GetObjectStringValue=O,l.ObjectControl=A,l.ObjectGetIdList=_,l.GetRoomOnlineUsers=G,l.SendTextMessage=L,l.GetSDKOptionString=x,l.GetSDKOptionInt=D,l.TransBuffer=g,l.TransBufferEx=b,l.GetVersion=U,l.GetCurrentDevice=F,l.QueryUserStateInt=W,l.UserSpeakControlEx=j,l.GetUserFriends=P,l.GetUserInfo=z,l.GetFriendStatus=H,l.QueryInfoFromServer=K,l.QueryUserStateString=J,l.StreamRecordCtrl=Q,l.SelectDevice=ie,l.SnapShot=re,l};t.instance=p,t.Uploadlog=o},function(e,t,n){function o(){this.events={}}function i(){this.localMediaStream=null,this.roomid="",this.userid=-1,this.socket=null,this.sessionid=null,this.is_socket=!1,this.peerConnections={},this.connections=[],this.numStreams=0,this.initializedStreams=0,this.browserName="",this.normalCloseWebsocket=!1,this.userlist=[],this.timeOut=0,this.timeOutInt=s.timeOutInt,this.srrc_index=0,this.sendData={},this.system="",this.mobile_type=0,this.queueId="",this.bitrate=s.bitrate,this.videowidth=s.videowidth,this.videoheight=s.videoheight,this.videofps=s.videofps}function r(e,t){var n="AS";return e=e.indexOf("b="+n+":")===-1?e.replace(/c=IN (.*)\r\n/,"c=IN $1\r\nb="+n+":"+t+"\r\n"):e.replace(new RegExp("b="+n+":.*\r\n"),"b="+n+":"+t+"\r\n"),log("更新码率"+t),e}var a=n(3),s=n(4),d=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection||"",c=window.URL||window.webkitURL||window.msURL||window.oURL||"",u=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||"",f=window.mozRTCIceCandidate||window.RTCIceCandidate||"",l=window.mozRTCSessionDescription||window.RTCSessionDescription||"",h=(!!navigator.mozGetUserMedia,{iceServers:[{urls:"stun:h5.anychat.cn:9000"}]});o.prototype.on=function(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)},o.prototype.emit=function(e,t){var n,o,i=this.events[e],r=Array.prototype.slice.call(arguments,1);if(i)for(n=0,o=i.length;n<o;n++)i[n].apply(null,r)},i.prototype=new o,i.prototype.connect=function(e){var t,n=this;if(this.socket)return log("不需要重连，已经存在websocket 链接"),!1;var o="https:"==document.location.protocol,i=o?"wss:"+e[0]:"ws:"+e[0];if("WebSocket"in window)t=this.socket=new WebSocket(i,"anychat-protocol");else{if(!("MozWebSocket"in window))return log("不支持websocket"),void alert("WebSocket is not supported by this browser.");t=this.socket=new MozWebSocket(i,"anychat-protocol")}t.onopen=function(){n.is_socket=!0;var e={};e=n.sessionid?{eventname:"request",ssrc:0,data:{cmdcode:"tokenconnect",sessionid:n.sessionid}}:{eventname:"request",ssrc:0,data:{cmdcode:"connect"}},t.send(JSON.stringify(e))},t.onmessage=function(e){var o=JSON.parse(e.data),i=o.data;"object"!=typeof i&&(o.data=JSON.parse(i)),o.eventname?n.emit(o.eventname,o):n.emit("socket_receive_message",t,o)},t.onerror=function(e){console.log("socket_error"),n.socket=!1,n.is_socket=!1,n.emit("socket_error",e,t)},t.onclose=function(e){n.is_socket=!1,n.socket=!1,n.normalCloseWebsocket||n.emit("close_websocket",e),n.normalCloseWebsocket=!1},n.on("ready",function(){})},i.prototype.socket_send=function(e,t,n,o){var i={};if(i.eventname=e,i.ssrc=0,o.userid&&(o.userid=parseInt(o.userid)),i.data={},i.data=o,i.data.cmdcode=n,i=a.data_pack(i),this.is_socket)try{1==this.socket.readyState&&this.socket.send(JSON.stringify(i))}catch(e){log("socket"+e)}},i.prototype.data_pack=function(e){},i.prototype.support=function(){return!!d},i.prototype.createStream=function(e,t){function n(){log("StreamConfig:"+JSON.stringify(s)),"ios"===a.system?navigator.mediaDevices.getUserMedia(s).then(function(e){a.localMediaStream=e,a.initializedStreams++,log("My own video stream opened successfully"),a.emit("stream_created",e)},function(e){throw log("视频流打开失败:"+e),"retry"}):u.call(navigator,s,function(e){a.localMediaStream=e,a.initializedStreams++,log("My own video stream opened successfully"),a.emit("stream_created",e)},function(e){throw log("视频流打开失败:"+e),"retry"})}var o,i,r,a=this,s={};if(t?(o=t.width||this.videowidth,i=t.height||this.videoheight,r=t.fpsctrl||this.videofps):(o=this.videowidth,i=this.videoheight,r=this.videofps),console.log("摄像头打开信息，分辨率w:"+o+"；分辨率h："+i),s.video={},s.audio=!1,e&&(s.video.optional=[{sourceId:e}]),u)try{1==a.mobile_type?s.video.mandatory={minHeight:0,maxHeight:i,minWidth:0,maxWidth:o,maxFrameRate:r,minAspectRatio:.75,maxAspectRatio:.75}:s.video.mandatory={minHeight:0,maxHeight:i,minWidth:0,maxWidth:o,maxFrameRate:r,minAspectRatio:1.333333,maxAspectRatio:1.333333},n()}catch(t){try{log("Open camera failure:"+t),log("Try again to open the camera"),s.video={height:{min:10,ideal:i,max:1280},width:{min:10,ideal:o,max:720},frameRate:{ideal:r,max:60}},e&&(s.video.optional={sourceId:e}),n()}catch(e){log("Open camera failure:"+e),log("Try again to open the camera"),s.video=!0,n()}}else log("不支持视频流")},i.prototype.addStreams=function(e){var t=this,n=setInterval(function(){t.localMediaStream&&(clearInterval(n),t.peerConnections[e].addStream(t.localMediaStream),t.sendOffers(e))},100)},i.prototype.attachStream=function(e,t){var n=document.getElementById(t);if(!n)return log("找不到可以设置video 标签的div"),!1;if("my"===n.className){if("ios"===this.system)try{var o=new MediaStream;o.addTrack(e.getVideoTracks()[0]),n.srcObject=o}catch(e){alert(e)}else n.src=c.createObjectURL(e);n.volume=0,n.muted=!1,n.style.transform=" rotateY(180deg)"}else"ios"===this.system?n.srcObject=e:n.src=c.createObjectURL(e);n.addEventListener("canplaythrough",function(){log("video_height："+n.clientHeight),log("video_width:"+n.clientWidth)})},i.prototype.sendOffers=function(e){var t,n=this,o={};pcCreateOfferCbGen=function(e,t){return function(i){e.setLocalDescription(i),o=i,n.emit("offer",o,t),log("发送offer给对方")}},pcCreateOfferErrorCb=function(e){log("发送offer报错："+e),console.log(e)},t=this.peerConnections[e],t.createOffer(pcCreateOfferCbGen(t,e),pcCreateOfferErrorCb)},i.prototype.updatebrandwidth=function(e,t){var n;n=this.peerConnections[e],n&&n.createOffer().then(function(e){return n.setLocalDescription(e)}).then(function(){var e={type:n.remoteDescription.type,sdp:r(n.remoteDescription.sdp,t)};return n.setRemoteDescription(e)}).then(function(){}).catch()},i.prototype.receiveOffer=function(e,t){this.peerConnections[e];this.sendAnswer(e,t)},i.prototype.sendAnswer=function(e,t){var n=this.peerConnections[e],o=this;n.setRemoteDescription(new l(t)),n.createAnswer(function(t){n.setLocalDescription(t),o.socket.send(JSON.stringify({eventName:"__answer",data:{socketId:e,sdp:t}}))},function(e){console.log(e)})},i.prototype.receiveAnswer=function(e,t){var n=this.peerConnections[e];if(!n)return!1;var o={};o.type="answer",o.sdp=t,n.setRemoteDescription(new l(o))},i.prototype.createPeerConnections=function(){var e,t;for(e=0,t=this.connections.length;e<t;e++)this.createPeerConnection(this.connections[e])},i.prototype.createPeerConnection=function(e,t){var n=this;try{var o=new d(h)}catch(e){return log(e),!1}this.peerConnections[e]=o;var i={},r={sdpMid:"",sdpMLineIndex:"",candidate:""};return o.onicecandidate=function(o){if("object"==typeof o.candidate)try{r.sdpMid=o.candidate.sdpMid,r.sdpMLineIndex=o.candidate.sdpMLineIndex,r.candidate=o.candidate.candidate,r.peerconnectionid=e,r.streamindex=t,r.type="candidate",o.candidate&&(i.jsonbuf=r,n.socket_send("request",0,"webrtcconsult",i))}catch(e){log("onicecandidate warm")}},o.onopen=function(){log("peerConnections打开成功")},o.onaddstream=function(t){n.emit("pc_add_stream",t.stream,e,o)},o.onremovestream=function(e){log("onremovestream")},o.ondatachannel=function(e){},o.oniceconnectionstatechange=function(){},o.onidentityresult=function(){},o.onidpassertionerror=function(){},o.onidpvalidationerror=function(){},o.onnegotiationneeded=function(){},o.onpeeridentity=function(){},o.onsignalingstatechange=function(){},o},i.prototype.closePeerConnection=function(e){e&&e.close()},i.prototype.closeAllPeerConnection=function(){for(var e in this.peerConnections)this.peerConnections[e].close(),delete this.peerConnections[e];log("关闭peerConnection")},i.prototype.closeOtherPeerConnection=function(e){this.peerConnections[e]&&(this.peerConnections[e].close(),delete this.peerConnections[e]),log("关闭他人peerConnection:"+e)},i.prototype.removeVideo=function(){function e(e){var t=e.parentNode;t&&t.removeChild(e)}var t=document.querySelectorAll("video.my,video.other");for(var n in t)isNaN(n)||e(t[n]);log("移除video标签")},i.prototype.removeMyVideo=function(){function e(e){var t=e.parentNode;t&&t.removeChild(e)}var t=document.querySelectorAll("video.my");for(var n in t)e(t[n]);log("移除自己video标签")},i.prototype.removeOtherVideo=function(e){function t(e){var t=e.parentNode;t&&t.removeChild(e)}var n=document.querySelectorAll("video.other");for(var o in n)isNaN(o)||n[o].getAttribute("name")==e&&t(n[o]);log("移除他人video标签："+e)},i.prototype.candidate=function(e){var t=this.peerConnections[e.peerconnectionid];if(!t)return!1;try{var n=new f(e);t.addIceCandidate(n)}catch(n){t.addIceCandidate(e)}},t.instance=i},function(e,t){function n(e){return"heartbeat"!==e.data.cmdcode&&(e.seq=++l,f[l]=e),e}function o(e){for(var t=e;t>=h;t--)delete f[t];h=e}function i(e){u=e,setInterval(function(){a()},m)}function r(e){e-p===1||s(p),p=e}function a(){var e={eventname:"ack",ssrc:0,seq:p,data:{}};u.is_socket&&u.socket.send(JSON.stringify(e))}function s(e){var t={eventname:"request",ssrc:0,seq:0,data:{cmdcode:"restrans",begin_reg:++e}};u.is_socket&&u.socket.send(JSON.stringify(t))}function d(e){for(var t in f)t>e&&u.is_socket&&f[t]&&(u.socket.send(JSON.stringify(f[t])),delete f[t])}function c(){l=0,p=0}var u,f={},l=0,h=0,p=0,m=3e3;t.data_pack=n,t.delt_pack=o,t.setWay=i,t.set_big_index_notify=r,t.restrans_to_service=d,t.clear_all=c},function(e,t){var n={timeOutInt:30,bitrate:200,videowidth:320,videoheight:240,videofps:15};e.exports=n},function(e,t){function n(e){var t={};clearInterval(r),r=setInterval(function(){e.socket_send("request",0,"heartbeat",t)},1e3*a)}function o(e){}function i(){r&&clearInterval(r)}var r,a=5;t.start=n,t.notify=o,t.stop=i},function(e,t,n){var o=(n(7),function(){function e(e){this.getway=e,this.objectInfoData={},this.objectInfoData_1={},this.objectidlist_5=[]}return e.prototype.setObjectInfo=function(e){var t=e.objecttype+"_"+e.objectid;this.objectInfoData[t]||e.objecttype==i&&this.objectidlist_5.push(e.objectid),this.objectInfoData[t]=JSON.parse(e.jsonbuf)},e.prototype.setObjectInfo_1=function(e){var t=e.objecttype+"_"+e.objectid;this.objectInfoData_1[t]=JSON.parse(e.jsonbuf)},e.prototype.GetObjectIntValue=function(e,t,n){var o=this,i=0,a=e+"_"+t;return o.objectInfoData[a]?(n==r?i=o.objectInfoData[a].flags:n==s?i=o.objectInfoData[a].priority:n==d?i=o.objectInfoData[a].attribute:n==u?i=o.objectInfoData[a].inttag:n==h?i=o.objectInfoData_1[a].beforeusernum:n==l?i=o.objectInfoData_1[a].mysequenceno:n==p?i=o.objectInfoData_1[a].myenterqueuetime:n==v?i=o.objectInfoData_1[a].waittimesecond:n==m&&(i=o.objectInfoData_1[a].queuelength),i):"undefined"},e.prototype.GetObjectStringValue=function(e,t,n){var o=this,i="",r=e+"_"+t;return o.objectInfoData[r]?(n==a?i=o.objectInfoData[r].objectname:n==c?i=o.objectInfoData[r].description:n==f&&(i=o.objectInfoData[r].stringtag),i):"undefined"},e.prototype.ObjectGetIdList=function(e){if(e==i)return this.objectidlist_5},e}()),i=5,r=7,a=8,s=9,d=10,c=11,u=12,f=13,l=501,h=502,p=503,m=504,v=508;e.exports=o},function(e,t){function n(e){var t,n,o,r,a,s;for(o=e.length,n=0,t="";n<o;){if(r=255&e.charCodeAt(n++),n==o){t+=i.charAt(r>>2),t+=i.charAt((3&r)<<4),t+="==";break}if(a=e.charCodeAt(n++),n==o){t+=i.charAt(r>>2),t+=i.charAt((3&r)<<4|(240&a)>>4),t+=i.charAt((15&a)<<2),t+="=";break}s=e.charCodeAt(n++),t+=i.charAt(r>>2),t+=i.charAt((3&r)<<4|(240&a)>>4),t+=i.charAt((15&a)<<2|(192&s)>>6),t+=i.charAt(63&s)}return t}function o(e){var t,n,o,i,a,s,d;for(s=e.length,a=0,d="";a<s;){do t=r[255&e.charCodeAt(a++)];while(a<s&&t==-1);if(t==-1)break;do n=r[255&e.charCodeAt(a++)];while(a<s&&n==-1);if(n==-1)break;d+=String.fromCharCode(t<<2|(48&n)>>4);do{if(o=255&e.charCodeAt(a++),61==o)return d;o=r[o]}while(a<s&&o==-1);if(o==-1)break;d+=String.fromCharCode((15&n)<<4|(60&o)>>2);do{if(i=255&e.charCodeAt(a++),61==i)return d;i=r[i]}while(a<s&&i==-1);if(i==-1)break;d+=String.fromCharCode((3&o)<<6|i)}return d}var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);t.base64encode=n,t.base64decode=o},function(e,t,n){var o,i=n(7),r=function(e){function t(e,t,n){for(var o=e.split("\r\n"),i=-1,r=0;r<o.length;r++)if(console.log("m="+t),0===o[r].indexOf("m="+t)){i=r;break}if(i===-1)return console.debug("Could not find the m line for",t),e;for(console.debug("Found the m line for",t,"at line",i),i++;0===o[i].indexOf("i=")||0===o[i].indexOf("c=");)i++;if(0===o[i].indexOf("b"))return console.debug("Replaced b line at line",i),o[i]-"b=AS."+n,o.join("\r\n");console.debug("Adding new b line before line",i);var a=o.slice(0,i);return a.push("b=AS:"+n),a=a.concat(o.slice(i,o.length)),a.join("\r\n")}var n={};return n.createStream=function(t,n){var o;t?(o=t.id||t.deviceId,e.createStream(o,n)):e.createStream("",n)},n.clear_timer=function(){e.timeOut=0,o||(clearInterval(o),o=null)},n.tokenconnect=function(t,n){o||(o=setInterval(function(){return e.is_socket?(clearInterval(o),o=null,!1):(e.timeOut++,log("正在重连："+e.timeOut),void(e.timeOut==e.timeOutInt&&(e.is_socket||(clearInterval(o),BRAC_LeaveRoom(),e.emit("linkclose",100),e.sendData={},e.roomid="",e.sessionid="",e.timeOut=0,o=null))))},1e3)),setTimeout(function(){e.socket=null,e.connect(t)},4e3)},n.strema_video=function(t,n,o,i){var r,a={},s=t.streamindex_video;switch(o){case BRAC_SO_LOCALVIDEO_DEVICENAME:case BRAC_STREAMINFO_VIDEOCODECID:a.dwStreamIndex=n,a.cameraName=i,s[n]=a;break;case BRAC_SO_LOCALVIDEO_WIDTHCTRL:r==-1||(s[n].width=i);break;case BRAC_SO_LOCALVIDEO_HEIGHTCTRL:r==-1||(s[n].height=i);break;case BRAC_SO_LOCALVIDEO_FPSCTRL:r==-1||(s[n].fpsctrl=i);break;case BRAC_SO_LOCALVIDEO_BITRATECTRL:e.bitrate=i/1e3,r==-1||(s[n].fpscode=i)}return s},n.getBrowser=function(){var e="unknown browser",t=navigator.userAgent.toLowerCase(),n={ie:/msie/.test(t)&&!/opera/.test(t),op:!/msie/.test(t)&&/opera/.test(t),sa:/version.*safari/.test(t),ch:/chrome/.test(t)&&window.navigator.webkitPersistentStorage,ff:/firefox/.test(t),qh360:/chrome/.test(t)&&!window.navigator.webkitPersistentStorage,qq:/qqbrowser/.test(t),sg:/metasr/.test(t)};return n.ch?e="Chrome":n.ie?e="IE":n.ff?e="Firefox":n.sa?e="Safari":n.qh360?e="360浏览器":n.op?e="Opera":n.qq?e="QQ浏览器":n.sg&&(e="搜狗浏览器"),e},n.system_s=function(t){if(!navigator)return 1===t?3:"ios";var n=navigator.userAgent;n.indexOf("Chrome/60.0.3112.116")>0&&(e.mobile_type=1);for(var o=new Array("Android"),i=new Array("iPhone","iPad","iPod","Safari"),r=new Array("Windows"),a=0;a<o.length;a++){var s=n.indexOf(o[a]);if(s>0)return 1===t?2:"android"}for(var a=0;a<r.length;a++){var s=n.indexOf(r[a]);if(s>0)return 1===t?1:"windows"}for(var a=0;a<i.length;a++){var s=n.indexOf(i[a]);if(s>0)return 1===t?n.indexOf("iPhone")>0?(log("iphone"),4):3:"ios"}},n.log=function(e){console.log(e)},n.closeAll=function(t){try{for(var n in t)t[n]&&(log("Turn off camera"),log(t[n].getVideoTracks()[0]),t[n].getVideoTracks()[0].stop(),t[n]="",e.localMediaStream=null)}catch(e){log(e)}e.closeAllPeerConnection(),e.removeVideo()},n.closeMyCamera=function(t){try{log("Turn off camera"),t[0].getVideoTracks()[0].stop(),t[0]="",e.removeMyVideo(),e.localMediaStream=null}catch(e){log(e)}},n.closeOtherCamera=function(t){e.closeOtherPeerConnection(t),e.removeOtherVideo(t)},n.SetSDKOptionString=function(t){for(var n in t){var o={};o=t[n],e.socket_send("request",0,"setsdkoptionstring",o)}},n.SetSDKOptionInt=function(t){for(var n in t){var o={};o=t[n],e.socket_send("request",0,"setsdkoptionint",o)}},n.ArrayremoveByValue=function(e,t){for(var n=0;n<e.length;n++)if(e[n]==t){e.splice(n,1);break}},n.base64encode=i.base64encode,n.base64decode=i.base64decode,n.setMediaBitrates=function(e,n,o){return t(t(e,"video",n),"audio",o)},n.funDownload=function(e,t){var n=document.createElement("a");n.download=t,n.style.display="none";var o=new Blob([e]);n.href=URL.createObjectURL(o),document.body.appendChild(n),n.click(),document.body.removeChild(n)},n.getStringLength=function(e){
for(var t,n=e,o=0;o<n.length;o++){var i=n.charAt(o);t+=/^[\u0000-\u00ff]$/.test(i)?1:3}return t},n};t.instance=r},function(e,t){(function(e){"use strict";function n(e){if(!e)throw"MediaStream is mandatory.";this.start=function(n){var o;"undefined"!=typeof MediaRecorder?o=c:(y||w||b)&&(this.mimeType.indexOf("video")!==-1?o=l:this.mimeType.indexOf("audio")!==-1&&(o=u)),"image/gif"===this.mimeType&&(o=p),"audio/wav"!==this.mimeType&&"audio/pcm"!==this.mimeType||(o=u),this.recorderType&&(o=this.recorderType),t=new o(e),t.blobs=[];var i=this;t.ondataavailable=function(e){t.blobs.push(e),i.ondataavailable(e)},t.onstop=this.onstop,t.onStartedDrawingNonBlankFrames=this.onStartedDrawingNonBlankFrames,t=r(t,this),t.start(n)},this.onStartedDrawingNonBlankFrames=function(){},this.clearOldRecordedFrames=function(){t&&t.clearOldRecordedFrames()},this.stop=function(){t&&t.stop()},this.ondataavailable=function(e){this.disableLogs||console.log("ondataavailable..",e)},this.onstop=function(e){console.warn("stopped..",e)},this.save=function(e,n){if(!e){if(!t)return;return void ConcatenateBlobs(t.blobs,t.blobs[0].type,function(e){a(e)})}a(e,n)},this.pause=function(){t&&(t.pause(),this.disableLogs||console.log("Paused recording.",this.mimeType||t.mimeType))},this.resume=function(){t&&(t.resume(),this.disableLogs||console.log("Resumed recording.",this.mimeType||t.mimeType))},this.recorderType=null,this.mimeType="video/webm",this.disableLogs=!1;var t}function o(e,t){function o(){var t=[];return e.forEach(function(e){e.getVideoTracks().forEach(function(e){t.push(e)})}),t}e=e||[],e instanceof S&&(e=[e]);var r,a,s=this;t=t||{mimeType:"video/webm",video:{width:360,height:240}},t.frameInterval||(t.frameInterval=10),t.video||(t.video={}),t.video.width||(t.video.width=360),t.video.height||(t.video.height=240),this.start=function(d){r=new i(e),o().length&&(r.frameInterval=t.frameInterval||10,r.width=t.video.width||360,r.height=t.video.height||240,r.startDrawingFrames()),"function"==typeof s.previewStream&&s.previewStream(r.getMixedStream()),a=new n(r.getMixedStream());for(var c in s)"function"!=typeof s[c]&&(a[c]=s[c]);a.ondataavailable=function(e){s.ondataavailable(e)},a.onstop=s.onstop,a.start(d)},this.stop=function(e){a&&a.stop(function(t){e(t)})},this.pause=function(){a&&a.pause()},this.resume=function(){a&&a.resume()},this.clearRecordedData=function(){a&&(a.clearRecordedData(),a=null),r&&(r.releaseStreams(),r=null)},this.addStreams=this.addStream=function(t){if(!t)throw"First parameter is required.";t instanceof Array||(t=[t]),e.concat(t),a&&r&&r.appendStreams(t)},this.resetVideoStreams=function(e){r&&(!e||e instanceof Array||(e=[e]),r.resetVideoStreams(e))},this.ondataavailable=function(e){s.disableLogs||console.log("ondataavailable",e)},this.onstop=function(){},this.name="MultiStreamRecorder",this.toString=function(){return this.name}}function i(e){function t(){if(!c){var e=d.length,o=!1,i=[];d.forEach(function(e){e.stream||(e.stream={}),e.stream.fullcanvas?o=e:i.push(e)}),o?(u.width=o.stream.width,u.height=o.stream.height):i.length?(u.width=e>1?2*i[0].width:i[0].width,u.height=e>2?2*i[0].height:i[0].height):(u.width=l.width||360,u.height=l.height||240),o&&o instanceof HTMLVideoElement&&n(o),i.forEach(function(e,t){n(e,t)}),setTimeout(t,l.frameInterval)}}function n(e,t){if(!c){var n=0,o=0,i=e.width,r=e.height;1===t&&(n=e.width),2===t&&(o=e.height),3===t&&(n=e.width,o=e.height),"undefined"!=typeof e.stream.left&&(n=e.stream.left),"undefined"!=typeof e.stream.top&&(o=e.stream.top),"undefined"!=typeof e.stream.width&&(i=e.stream.width),"undefined"!=typeof e.stream.height&&(r=e.stream.height),f.drawImage(e,n,o,i,r),"function"==typeof e.stream.onRender&&e.stream.onRender(f,n,o,i,r,t)}}function o(){c=!1;var t=i(),n=r();n&&n.getAudioTracks().forEach(function(e){t.addTrack(e)});var o;return e.forEach(function(e){e.fullcanvas&&(o=!0)}),t}function i(){s();var e;"captureStream"in u?e=u.captureStream():"mozCaptureStream"in u?e=u.mozCaptureStream():l.disableLogs||console.error("Upgrade to latest Chrome or otherwise enable this flag: chrome://flags/#enable-experimental-web-platform-features");var t=new m;return e.getVideoTracks().forEach(function(e){t.addTrack(e)}),u.stream=t,t}function r(){v.AudioContextConstructor||(v.AudioContextConstructor=new v.AudioContext),l.audioContext=v.AudioContextConstructor,l.audioSources=[],l.useGainNode===!0&&(l.gainNode=l.audioContext.createGain(),l.gainNode.connect(l.audioContext.destination),l.gainNode.gain.value=0);var t=0;if(e.forEach(function(e){if(e.getAudioTracks().length){t++;var n=l.audioContext.createMediaStreamSource(e);l.useGainNode===!0&&n.connect(l.gainNode),l.audioSources.push(n)}}),t)return l.audioDestination=l.audioContext.createMediaStreamDestination(),l.audioSources.forEach(function(e){e.connect(l.audioDestination)}),l.audioDestination.stream}function a(e){var t=document.createElement("video");return"srcObject"in t?t.srcObject=e:t.src=p.createObjectURL(e),t.muted=!0,t.volume=0,t.width=e.width||l.width||360,t.height=e.height||l.height||240,t.play(),t}function s(t){d=[],t=t||e,t.forEach(function(e){if(e.getVideoTracks().length){var t=a(e);t.stream=e,d.push(t)}})}var d=[],c=!1,u=document.createElement("canvas"),f=u.getContext("2d");u.style="opacity:0;position:absolute;z-index:-1;top: -100000000;left:-1000000000; margin-top:-1000000000;margin-left:-1000000000;",(document.body||document.documentElement).appendChild(u),this.disableLogs=!1,this.frameInterval=10,this.width=360,this.height=240,this.useGainNode=!0;var l=this,h=window.AudioContext;"undefined"==typeof h&&("undefined"!=typeof webkitAudioContext&&(h=webkitAudioContext),"undefined"!=typeof mozAudioContext&&(h=mozAudioContext));var p=window.URL;"undefined"==typeof p&&"undefined"!=typeof webkitURL&&(p=webkitURL),"undefined"!=typeof navigator&&"undefined"==typeof navigator.getUserMedia&&("undefined"!=typeof navigator.webkitGetUserMedia&&(navigator.getUserMedia=navigator.webkitGetUserMedia),"undefined"!=typeof navigator.mozGetUserMedia&&(navigator.getUserMedia=navigator.mozGetUserMedia));var m=window.MediaStream;"undefined"==typeof m&&"undefined"!=typeof webkitMediaStream&&(m=webkitMediaStream),"undefined"!=typeof m&&("getVideoTracks"in m.prototype||(m.prototype.getVideoTracks=function(){if(!this.getTracks)return[];var e=[];return this.getTracks.forEach(function(t){t.kind.toString().indexOf("video")!==-1&&e.push(t)}),e},m.prototype.getAudioTracks=function(){if(!this.getTracks)return[];var e=[];return this.getTracks.forEach(function(t){t.kind.toString().indexOf("audio")!==-1&&e.push(t)}),e}),"undefined"==typeof m.prototype.stop&&(m.prototype.stop=function(){this.getTracks().forEach(function(e){e.stop()})}));var v={};"undefined"!=typeof h?v.AudioContext=h:"undefined"!=typeof webkitAudioContext&&(v.AudioContext=webkitAudioContext),this.startDrawingFrames=function(){t()},this.appendStreams=function(t){if(!t)throw"First parameter is required.";t instanceof Array||(t=[t]),e.concat(t),t.forEach(function(e){if(e.getVideoTracks().length){var t=a(e);t.stream=e,d.push(t)}if(e.getAudioTracks().length&&l.audioContext){var n=l.audioContext.createMediaStreamSource(e);n.connect(l.audioDestination),l.audioSources.push(n)}})},this.releaseStreams=function(){d=[],c=!0,l.gainNode&&(l.gainNode.disconnect(),l.gainNode=null),l.audioSources.length&&(l.audioSources.forEach(function(e){e.disconnect()}),l.audioSources=[]),l.audioDestination&&(l.audioDestination.disconnect(),l.audioDestination=null),l.audioContext=null,f.clearRect(0,0,u.width,u.height),u.stream&&(u.stream.stop(),u.stream=null)},this.resetVideoStreams=function(e){!e||e instanceof Array||(e=[e]),s(e)},this.name="MultiStreamsMixer",this.toString=function(){return this.name},this.getMixedStream=o}function r(e,t){for(var n in t)"function"!=typeof t[n]&&(e[n]=t[n]);return e}function a(e,t){if(!e)throw"Blob object is required.";if(!e.type)try{e.type="video/webm"}catch(e){}var n=(e.type||"video/webm").split("/")[1];if(t&&t.indexOf(".")!==-1){var o=t.split(".");t=o[0],n=o[1]}var i=(t||Math.round(9999999999*Math.random())+888888888)+"."+n;if("undefined"!=typeof navigator.msSaveOrOpenBlob)return navigator.msSaveOrOpenBlob(e,i);if("undefined"!=typeof navigator.msSaveBlob)return navigator.msSaveBlob(e,i);var r=document.createElement("a");r.href=g.createObjectURL(e),r.target="_blank",r.download=i,navigator.mozGetUserMedia&&(r.onclick=function(){(document.body||document.documentElement).removeChild(r)},(document.body||document.documentElement).appendChild(r));var a=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});r.dispatchEvent(a),navigator.mozGetUserMedia||g.revokeObjectURL(r.href)}function s(e){var t=1e3,n=["Bytes","KB","MB","GB","TB"];if(0===e)return"0 Bytes";var o=parseInt(Math.floor(Math.log(e)/Math.log(t)),10);return(e/Math.pow(t,o)).toPrecision(3)+" "+n[o]}function d(){var e=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,t=!!window.chrome&&!e,n="undefined"!=typeof window.InstallTrigger;if(n)return!0;if(!t)return!1;var o,i,r=(navigator.appVersion,navigator.userAgent),a=""+parseFloat(navigator.appVersion),s=parseInt(navigator.appVersion,10);return t&&(o=r.indexOf("Chrome"),a=r.substring(o+7)),(i=a.indexOf(";"))!==-1&&(a=a.substring(0,i)),(i=a.indexOf(" "))!==-1&&(a=a.substring(0,i)),s=parseInt(""+a,10),isNaN(s)&&(a=""+parseFloat(navigator.appVersion),s=parseInt(navigator.appVersion,10)),s>=49}function c(e){function t(){if("active"in e){if(!e.active)return!1}else if("ended"in e&&e.ended)return!1;return!0}var n=this;this.start=function(t,i){if(this.timeSlice=t||5e3,n.mimeType||(n.mimeType="video/webm"),n.mimeType.indexOf("audio")!==-1&&e.getVideoTracks().length&&e.getAudioTracks().length){var r;navigator.mozGetUserMedia?(r=new S,r.addTrack(e.getAudioTracks()[0])):r=new S(e.getAudioTracks()),e=r}n.mimeType.indexOf("audio")!==-1&&(n.mimeType=y?"audio/webm":"audio/ogg"),n.dontFireOnDataAvailableEvent=!1;var a={mimeType:n.mimeType};n.disableLogs||i||console.log("Passing following params over MediaRecorder API.",a),o&&(o=null),y&&!d()&&(a="video/vp8");try{o=new MediaRecorder(e,a)}catch(t){o=new MediaRecorder(e)}"canRecordMimeType"in o&&o.canRecordMimeType(n.mimeType)===!1&&(n.disableLogs||console.warn("MediaRecorder API seems unable to record mimeType:",n.mimeType)),n.ignoreMutedMedia===!0&&(o.ignoreMutedMedia=!0);var s=!1;o.ondataavailable=function(e){if(e.data&&e.data.size&&!(e.data.size<26800)&&!s){s=!0;var i=n.getNativeBlob?e.data:new Blob([e.data],{type:n.mimeType||"video/webm"});n.ondataavailable(i),o&&"recording"===o.state&&o.stop(),o=null,n.dontFireOnDataAvailableEvent||n.start(t,"__disableLogs")}},o.onerror=function(e){n.disableLogs||("InvalidState"===e.name?console.error("The MediaRecorder is not in a state in which the proposed operation is allowed to be executed."):"OutOfMemory"===e.name?console.error("The UA has exhaused the available memory. User agents SHOULD provide as much additional information as possible in the message attribute."):"IllegalStreamModification"===e.name?console.error("A modification to the stream has occurred that makes it impossible to continue recording. An example would be the addition of a Track while recording is occurring. User agents SHOULD provide as much additional information as possible in the message attribute."):"OtherRecordingError"===e.name?console.error("Used for an fatal error other than those listed above. User agents SHOULD provide as much additional information as possible in the message attribute."):"GenericError"===e.name?console.error("The UA cannot provide the codec or recording option that has been requested.",e):console.error("MediaRecorder Error",e)),o&&"inactive"!==o.state&&"stopped"!==o.state&&o.stop()};try{o.start(36e5)}catch(e){o=null}setTimeout(function(){o&&"recording"===o.state&&o.requestData()},t)},this.stop=function(e){o&&"recording"===o.state&&(o.requestData(),setTimeout(function(){n.dontFireOnDataAvailableEvent=!0,o&&"recording"===o.state&&o.stop(),o=null,n.onstop()},2e3))},this.pause=function(){o&&("recording"===o.state&&o.pause(),this.dontFireOnDataAvailableEvent=!0)},this.ondataavailable=function(e){console.log("recorded-blob",e)},this.resume=function(){if(this.dontFireOnDataAvailableEvent){this.dontFireOnDataAvailableEvent=!1;var e=n.disableLogs;return n.disableLogs=!0,this.start(this.timeslice||5e3),void(n.disableLogs=e)}o&&"paused"===o.state&&o.resume()},this.clearRecordedData=function(){o&&(this.pause(),this.dontFireOnDataAvailableEvent=!0,this.stop())},this.onstop=function(){};var o;!function e(){if(o)return t()===!1?void n.stop():void setTimeout(e,1e3)}()}function u(e){this.start=function(o){o=o||1e3,t=new f(e,this),t.record(),n=setInterval(function(){t.requestData()},o)},this.stop=function(){t&&(t.stop(),clearTimeout(n),this.onstop())},this.pause=function(){t&&t.pause()},this.resume=function(){t&&t.resume()},this.ondataavailable=function(){},this.onstop=function(){};var t,n}function f(e,t){function n(e,t){for(var n=e.length+t.length,o=new Float32Array(n),i=0,r=0;r<n;)o[r++]=e[i],o[r++]=t[i],i++;return o}function o(e,t){for(var n=new Float32Array(t),o=0,i=e.length,r=0;r<i;r++){var a=e[r];n.set(a,o),o+=a.length}return n}function i(e,t,n){for(var o=n.length,i=0;i<o;i++)e.setUint8(t+i,n.charCodeAt(i))}function r(e){for(var t=e.length,n=new Int16Array(t);t--;)n[t]=65535*e[t];return n.buffer}var a=44100;C.AudioContextConstructor||(C.AudioContextConstructor=new C.AudioContext),a=C.AudioContextConstructor.sampleRate;var d,c,u,f,l=[],h=[],p=!1,m=0,v=t.sampleRate||a,g=t.mimeType||"audio/wav",b=g.indexOf("audio/pcm")>-1,w=t.audioChannels||2;this.record=function(){p=!0,l.length=h.length=0,m=0},this.requestData=function(){if(!k){if(0===m)return void(S=!1);S=!0;var e=l.slice(0),a=h.slice(0),d=m;l.length=h.length=[],m=0,S=!1;var c=o(e,d),u=c;if(2===w){var f=o(a,d);u=n(c,f)}if(b){var p=new Blob([r(u)],{type:"audio/pcm"});return console.debug("audio recorded blob size:",s(p.size)),void t.ondataavailable(p)}var g=new ArrayBuffer(44+2*u.length),y=new DataView(g);i(y,0,"RIFF"),y.setUint32(4,44+2*u.length-8,!0),i(y,8,"WAVE"),i(y,12,"fmt "),y.setUint32(16,16,!0),y.setUint16(20,1,!0),y.setUint16(22,w,!0),y.setUint32(24,v,!0),y.setUint32(28,v*w*2,!0),y.setUint16(32,2*w,!0),y.setUint16(34,16,!0),i(y,36,"data"),y.setUint32(40,2*u.length,!0);for(var C=u.length,O=44,A=1,_=0;_<C;_++)y.setInt16(O,u[_]*(32767*A),!0),O+=2;var p=new Blob([y],{type:"audio/wav"});console.debug("audio recorded blob size:",s(p.size)),t.ondataavailable(p)}},this.stop=function(){p=!1,this.requestData(),u.disconnect(),this.onstop()};var f=C.AudioContextConstructor;C.VolumeGainNode=f.createGain();var c=C.VolumeGainNode;C.AudioInput=f.createMediaStreamSource(e);var u=C.AudioInput;u.connect(c);var y=t.bufferSize||2048;if(0===t.bufferSize&&(y=0),f.createJavaScriptNode)d=f.createJavaScriptNode(y,w,w);else{if(!f.createScriptProcessor)throw"WebAudio API has no support on this browser.";d=f.createScriptProcessor(y,w,w)}y=d.bufferSize,console.debug("using audio buffer-size:",y);var S=!1;window.scriptprocessornode=d,1===w&&console.debug("All right-channels are skipped.");var k=!1;this.pause=function(){k=!0},this.resume=function(){k=!1},this.onstop=function(){},d.onaudioprocess=function(e){if(p&&!S&&!k){var t=e.inputBuffer.getChannelData(0);if(l.push(new Float32Array(t)),2===w){var n=e.inputBuffer.getChannelData(1);h.push(new Float32Array(n))}m+=y}},c.connect(d),d.connect(f.destination)}function l(e){this.start=function(o){o=o||1e3,t=new h(e,this);for(var i in this)"function"!=typeof this[i]&&(t[i]=this[i]);t.record(),n=setInterval(function(){t.requestData()},o)},this.stop=function(){t&&(t.stop(),clearTimeout(n),this.onstop())},this.onstop=function(){},this.clearOldRecordedFrames=function(){t&&t.clearOldRecordedFrames()},this.pause=function(){t&&t.pause()},this.resume=function(){t&&t.resume()},this.ondataavailable=function(){};var t,n}function h(e,t){function n(){if(m)return u=(new Date).getTime(),void setTimeout(n,500);if(!d){if(r)return setTimeout(n,100);var e=(new Date).getTime()-u;if(!e)return n();u=(new Date).getTime(),!p.isHTMLObject&&c.paused&&c.play(),h.drawImage(c,0,0,l.width,l.height),d||f.frames.push({duration:e,image:l.toDataURL("image/webp")}),a||o(f.frames[f.frames.length-1])||(a=!0,t.onStartedDrawingNonBlankFrames()),setTimeout(n,10)}}function o(e,t,n){var o=document.createElement("canvas");o.width=l.width,o.height=l.height;var i,r,a,s=o.getContext("2d"),d={r:0,g:0,b:0},c=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),u=t&&t>=0&&t<=1?t:0,f=n&&n>=0&&n<=1?n:0,h=new Image;h.src=e.image,s.drawImage(h,0,0,l.width,l.height);var p=s.getImageData(0,0,l.width,l.height);i=0,r=p.data.length,a=p.data.length/4;for(var m=0;m<r;m+=4){var v={r:p.data[m],g:p.data[m+1],b:p.data[m+2]},g=Math.sqrt(Math.pow(v.r-d.r,2)+Math.pow(v.g-d.g,2)+Math.pow(v.b-d.b,2));g<=c*u&&i++}return!(a-i<=a*f)}function i(e,t,n,o){var i=document.createElement("canvas");i.width=l.width,i.height=l.height;for(var r=i.getContext("2d"),a=[],s=t===-1,d=t&&t>0&&t<=e.length?t:e.length,c={r:0,g:0,b:0},u=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),f=n&&n>=0&&n<=1?n:0,h=o&&o>=0&&o<=1?o:0,p=!1,m=0;m<d;m++){var v,g,b;if(!p){var w=new Image;w.src=e[m].image,r.drawImage(w,0,0,l.width,l.height);var y=r.getImageData(0,0,l.width,l.height);v=0,g=y.data.length,b=y.data.length/4;for(var S=0;S<g;S+=4){var C={r:y.data[S],g:y.data[S+1],b:y.data[S+2]},k=Math.sqrt(Math.pow(C.r-c.r,2)+Math.pow(C.g-c.g,2)+Math.pow(C.b-c.b,2));k<=u*f&&v++}}!p&&b-v<=b*h||(s&&(p=!0),a.push(e[m]))}return a=a.concat(e.slice(d)),a.length<=0&&a.push(e[e.length-1]),a}this.record=function(o){this.width||(this.width=320),this.height||(this.height=240),this.video&&this.video instanceof HTMLVideoElement&&(this.width||(this.width=c.videoWidth||c.clientWidth||320),this.height||(this.height=c.videoHeight||c.clientHeight||240)),this.video||(this.video={width:this.width,height:this.height}),this.canvas&&this.canvas.width&&this.canvas.height||(this.canvas={width:this.width,height:this.height}),l.width=this.canvas.width,l.height=this.canvas.height,this.video&&this.video instanceof HTMLVideoElement?(this.isHTMLObject=!0,c=this.video.cloneNode()):(c=document.createElement("video"),c.srcObject=e,c.width=this.video.width,c.height=this.video.height),c.muted=!0,c.play(),u=(new Date).getTime(),f=new k.Video(t.speed,t.quality),console.log("canvas resolutions",l.width,"*",l.height),console.log("video width/height",c.width||l.width,"*",c.height||l.height),n()},this.clearOldRecordedFrames=function(){f.frames=[]};var r=!1;this.requestData=function(){if(!m){if(!f.frames.length)return void(r=!1);r=!0;var e=f.frames.slice(0);f.frames=i(e,-1),f.compile(function(e){t.ondataavailable(e),console.debug("video recorded blob size:",s(e.size))}),f.frames=[],r=!1}};var a=!1,d=!1;this.stop=function(){d=!0,this.requestData(),this.onstop()};var c,u,f,l=document.createElement("canvas"),h=l.getContext("2d"),p=this,m=!1;this.pause=function(){m=!0},this.resume=function(){m=!1},this.onstop=function(){}}function p(e){function t(){d=Date.now();var e=new Blob([new Uint8Array(u.stream().bin)],{type:"image/gif"});o.ondataavailable(e),u.stream().bin=[]}if("undefined"==typeof GIFEncoder)throw"Please link: https://cdn.webrtc-experiment.com/gif-recorder.js";this.start=function(e){function o(e){return n?void setTimeout(o,500,e):(l=requestAnimationFrame(o),void 0===typeof c&&(c=e),void(e-c<90||(a.paused&&a.play(),r.drawImage(a,0,0,d,h),u.addFrame(r),c=e)))}e=e||1e3;var d=this.videoWidth||320,h=this.videoHeight||240;i.width=a.width=d,i.height=a.height=h,u=new GIFEncoder,u.setRepeat(0),u.setDelay(this.frameRate||this.speed||200),u.setQuality(this.quality||1),u.start(),s=Date.now(),l=requestAnimationFrame(o),f=setTimeout(t,e)},this.stop=function(){l&&(cancelAnimationFrame(l),clearTimeout(f),t(),this.onstop())},this.onstop=function(){};var n=!1;this.pause=function(){n=!0},this.resume=function(){n=!1},this.ondataavailable=function(){},this.onstop=function(){};var o=this,i=document.createElement("canvas"),r=i.getContext("2d"),a=document.createElement("video");a.muted=!0,a.autoplay=!0,a.src=g.createObjectURL(e),a.play();var s,d,c,u,f,l=null}"undefined"!=typeof n&&(n.MultiStreamRecorder=o);var m="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";!function(t){"undefined"==typeof window&&("undefined"==typeof window&&"undefined"!=typeof e?(e.navigator={userAgent:m,getUserMedia:function(){}},t.window=e):"undefined"==typeof window,"undefined"==typeof document&&(t.document={},document.createElement=document.captureStream=document.mozCaptureStream=function(){return{}}),"undefined"==typeof location&&(t.location={protocol:"file:",href:"",hash:""}),"undefined"==typeof screen&&(t.screen={width:0,height:0}))}("undefined"!=typeof e?e:window);var v=window.AudioContext;"undefined"==typeof v&&("undefined"!=typeof webkitAudioContext&&(v=webkitAudioContext),"undefined"!=typeof mozAudioContext&&(v=mozAudioContext)),"undefined"==typeof window&&(window={});var v=window.AudioContext;"undefined"==typeof v&&("undefined"!=typeof webkitAudioContext&&(v=webkitAudioContext),"undefined"!=typeof mozAudioContext&&(v=mozAudioContext));var g=window.URL;"undefined"==typeof g&&"undefined"!=typeof webkitURL&&(g=webkitURL),"undefined"!=typeof navigator?("undefined"!=typeof navigator.webkitGetUserMedia&&(navigator.getUserMedia=navigator.webkitGetUserMedia),"undefined"!=typeof navigator.mozGetUserMedia&&(navigator.getUserMedia=navigator.mozGetUserMedia)):navigator={getUserMedia:function(){},userAgent:m};var b=!(navigator.userAgent.indexOf("Edge")===-1||!navigator.msSaveBlob&&!navigator.msSaveOrOpenBlob),w=!1;"undefined"!=typeof opera&&navigator.userAgent&&navigator.userAgent.indexOf("OPR/")!==-1&&(w=!0);var y=!b&&!b&&!!navigator.webkitGetUserMedia;y=!0,console.log("IsChrome:");var S=window.MediaStream;"undefined"==typeof S&&"undefined"!=typeof webkitMediaStream&&(S=webkitMediaStream),"undefined"!=typeof S&&("getVideoTracks"in S.prototype||(S.prototype.getVideoTracks=function(){if(!this.getTracks)return[];var e=[];return this.getTracks.forEach(function(t){t.kind.toString().indexOf("video")!==-1&&e.push(t)}),e},S.prototype.getAudioTracks=function(){if(!this.getTracks)return[];var e=[];return this.getTracks.forEach(function(t){t.kind.toString().indexOf("audio")!==-1&&e.push(t)}),e}),"stop"in S.prototype||(S.prototype.stop=function(){this.getAudioTracks().forEach(function(e){e.stop&&e.stop()}),this.getVideoTracks().forEach(function(e){e.stop&&e.stop()})})),"undefined"!=typeof location&&0===location.href.indexOf("file:")&&console.error("Please load this HTML file on HTTP or HTTPS.");var C={AudioContext:v};"undefined"!=typeof n&&(n.MediaRecorderWrapper=c),"undefined"!=typeof n&&(n.StereoAudioRecorder=u),"undefined"!=typeof n&&(n.StereoAudioRecorderHelper=f),"undefined"!=typeof n&&(n.WhammyRecorder=l),"undefined"!=typeof n&&(n.WhammyRecorderHelper=h),"undefined"!=typeof n&&(n.GifRecorder=p);var k=function(){function e(e,t){this.frames=[],e||(e=1),this.duration=1e3/e,this.quality=t||.8}function t(e){var t=g.createObjectURL(new Blob([e.toString(),"this.onmessage =  function (e) {"+e.name+"(e.data);}"],{type:"application/javascript"})),n=new Worker(t);return g.revokeObjectURL(t),n}function n(e){function t(e){var t=o(e);if(!t)return[];for(var i=3e4,r=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:l(t.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:29637},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:t.width,id:176},{data:t.height,id:186}]}]}]}]}],a=0,d=0;a<e.length;){var c=[],u=0;do c.push(e[a]),u+=e[a].duration,a++;while(a<e.length&&u<i);var f=0,h={id:524531317,data:n(d,f,c)};r[1].data.push(h),d+=u}return s(r)}function n(e,t,n){return[{data:e,id:231}].concat(n.map(function(e){var n=d({discardable:0,frame:e.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(t)});return t+=e.duration,{data:n,id:163}}))}function o(e){if(!e[0])return void postMessage({error:"Something went wrong. Maybe WebP format is not supported in the current browser."});for(var t=e[0].width,n=e[0].height,o=e[0].duration,i=1;i<e.length;i++)o+=e[i].duration;return{duration:o,width:t,height:n}}function i(e){for(var t=[];e>0;)t.push(255&e),e>>=8;return new Uint8Array(t.reverse())}function r(e){return new Uint8Array(e.split("").map(function(e){return e.charCodeAt(0)}))}function a(e){var t=[],n=e.length%8?new Array(9-e.length%8).join("0"):"";e=n+e;for(var o=0;o<e.length;o+=8)t.push(parseInt(e.substr(o,8),2));return new Uint8Array(t)}function s(e){for(var t=[],n=0;n<e.length;n++){var o=e[n].data;"object"==typeof o&&(o=s(o)),"number"==typeof o&&(o=a(o.toString(2))),"string"==typeof o&&(o=r(o));var d=o.size||o.byteLength||o.length,c=Math.ceil(Math.ceil(Math.log(d)/Math.log(2))/8),u=d.toString(2),f=new Array(7*c+7+1-u.length).join("0")+u,l=new Array(c).join("0")+"1"+f;t.push(i(e[n].id)),t.push(a(l)),t.push(o)}return new Blob(t,{type:"video/webm"})}function d(e){var t=0;if(e.keyframe&&(t|=128),e.invisible&&(t|=8),e.lacing&&(t|=e.lacing<<1),e.discardable&&(t|=1),e.trackNum>127)throw"TrackNumber > 127 not supported";var n=[128|e.trackNum,e.timecode>>8,255&e.timecode,t].map(function(e){return String.fromCharCode(e)}).join("")+e.frame;return n}function c(e){for(var t=e.RIFF[0].WEBP[0],n=t.indexOf("*"),o=0,i=[];o<4;o++)i[o]=t.charCodeAt(n+3+o);var r,a,s;return s=i[1]<<8|i[0],r=16383&s,s=i[3]<<8|i[2],a=16383&s,{width:r,height:a,data:t,riff:e}}function u(e,t){return parseInt(e.substr(t+4,4).split("").map(function(e){var t=e.charCodeAt(0).toString(2);return new Array(8-t.length+1).join("0")+t}).join(""),2)}function f(e){for(var t=0,n={};t<e.length;){var o=e.substr(t,4),i=u(e,t),r=e.substr(t+4+4,i);t+=8+i,n[o]=n[o]||[],"RIFF"===o||"LIST"===o?n[o].push(f(r)):n[o].push(r)}return n}function l(e){return[].slice.call(new Uint8Array(new Float64Array([e]).buffer),0).map(function(e){return String.fromCharCode(e)}).reverse().join("")}var h=new t(e.map(function(e){var t=c(f(atob(e.image.slice(23))));return t.duration=e.duration,t}));postMessage(h)}return e.prototype.add=function(e,t){if("canvas"in e&&(e=e.canvas),"toDataURL"in e&&(e=e.toDataURL("image/webp",this.quality)),!/^data:image\/webp;base64,/gi.test(e))throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp";this.frames.push({image:e,duration:t||this.duration})},e.prototype.compile=function(e){var o=t(n);o.onmessage=function(t){return t.data.error?void console.error(t.data.error):void e(t.data)},o.postMessage(this.frames)},{Video:e}}();"undefined"!=typeof n&&(n.Whammy=k),function(){window.ConcatenateBlobs=function(e,t,n){function o(){if(!e[a])return i();var t=new FileReader;t.onload=function(e){r.push(e.target.result),a++,o()},t.readAsArrayBuffer(e[a])}function i(){var e=0;r.forEach(function(t){e+=t.byteLength});var o=new Uint16Array(e),i=0;r.forEach(function(e){var t=e.byteLength;t%2!=0&&(e=e.slice(0,t-1)),o.set(new Uint16Array(e),i),i+=t});var a=new Blob([o.buffer],{type:t});n(a)}var r=[],a=0;o()}}(),t.MediaStreamRecorder=n}).call(t,function(){return this}())},function(e,t){t.upload=function(e,t,n){var o=new FormData;o.append("blob",t),$.ajax({url:"https://daishu.txiaoyuan.cn/upload/",type:"post",processData:!1,contentType:!1,data:o,success:function(e){console.log("上传成功")},error:function(e,t,n){console.log(t+"---"+n)}})}},function(e,t){var n=function(){function e(){this.filename="BRAnyChatCore.txt",this.log_txt="日志内容"}return e.prototype.explore=function(e,t,n){if(n)return this.weixinLog(e);var o=document.createElement("a");o.download=t,o.style.display="none";var i;try{i=new Blob([e],{type:"text/plain"})}catch(t){var r=BlobBuilder||WebKitBlobBuilder||MozBlobBuilder||"";if("TypeError"==t.name&&r){var a=new r;a.append([e]),i=a.getBlob("text/plain")}}o.href=URL.createObjectURL(i),document.body.appendChild(o),o.click(),document.body.removeChild(o)},e.prototype.weixinLog=function(e){function t(e){new Image;return e.toDataURL("image/jpeg")}function n(e,t,n,o,i){var r=t.getContext("2d");r.fillStyle="#ffffff",r.font="20px";for(var a=0,s=t.width,d=0,c=0;c<e.length;c++)a+=r.measureText(e[c]).width,(a>s-n||"&"==e[c])&&("&"==e[c],r.fillText(e.substring(d,c),n,o),o+=i,a=0,d=c),c==e.length-1&&r.fillText(e.substring(d,c+1),n,o)}var o=document.getElementById("myCanvas");return o.style.width="640px",n(e,o,20,20,22),t(o)},e.prototype.doExplore=function(e){return this.explore(this.log_txt,this.filename,e)},e.prototype.putLog=function(e){this.log_txt=e},e}(),o=new n;e.exports=o}]);